image: archlinux

secrets:
  - ea8ca0d9-1859-4db5-bb99-8f12baf60b59

packages:
  - clang
  - llvm
  - meson
  - nodejs
  - tree-sitter-cli
  - valgrind

sources:
  - git+ssh://git@git.sr.ht/~klahr/quadrate

environment:
  GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no"

tasks:
  - build: |
      cd quadrate
      make release
  - test: |
      cd quadrate
      make tests
  - test_optimized: |
      cd quadrate
      bash tests/run_tests.sh optimized -O2
      bash tests/run_tests.sh optimized -O3
  - valgrind: |
      cd quadrate
      export DEBUGINFOD_URLS="https://debuginfod.archlinux.org"
      make valgrind
  - mirror-to-github: |
      cd ~/quadrate
      ssh-keyscan github.com >> ~/.ssh/known_hosts
      git remote add github git@github.com:quadrate-language/quadrate.git || \
        git remote set-url github git@github.com:quadrate-language/quadrate.git
      git push --mirror github

triggers:
  - action: email
    condition: failure
    to: klahr@r8.rs
