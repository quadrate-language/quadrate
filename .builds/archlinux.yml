image: archlinux

secrets:
  - ea8ca0d9-1859-4db5-bb99-8f12baf60b59

packages:
  - clang
  - cmake
  - llvm
  - meson
  - nodejs
  - tree-sitter-cli
  - valgrind

sources:
  - git+ssh://git@git.sr.ht/~klahr/quadrate
  - https://git.sr.ht/~klahr/libu8t
  - https://git.sr.ht/~klahr/unit-check

environment:
  GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no"

tasks:
  - setup_unitcheck: |
      cd unit-check
      cmake -S . -B build
      cmake --build build --config Release
      sudo cmake --install build
  - setup_u8t: |
      cd libu8t
      cmake -S . -B build
      cmake --build build --config Release
      sudo cmake --install build
  - build: |
      cd quadrate
      make release
  - test: |
      cd quadrate
      make tests
  - test_optimized: |
      cd quadrate
      bash tests/run_tests.sh optimized -O2
      bash tests/run_tests.sh optimized -O3
  - valgrind: |
      cd quadrate
      export DEBUGINFOD_URLS="https://debuginfod.archlinux.org"
      make valgrind
  - mirror-to-github: |
      cd ~/quadrate
      ssh-keyscan github.com >> ~/.ssh/known_hosts
      git remote add github git@github.com:quadrate-language/quadrate.git || \
        git remote set-url github git@github.com:quadrate-language/quadrate.git
      git push --mirror github

triggers:
  - action: email
    condition: failure
    to: klahr@r8.rs
