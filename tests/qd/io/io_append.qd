// Test file append mode
use io
use mem

fn main( -- ) {
	// Write initial content
	"Line 1\n" mem::from_string
	-> len1
	-> buf1

	"/tmp/test_append.txt" io::Write io::open if {
		-> file
		file buf1 len1 io::write if {
			drop
			file io::close
		} else {
			drop file io::close
		}
	} else {
		drop
	}

	buf1 mem::free

	// Append more content
	"Line 2\n" mem::from_string
	-> len2
	-> buf2

	"/tmp/test_append.txt" io::Append io::open if {
		-> file
		file buf2 len2 io::write if {
			drop
			file io::close
		} else {
			drop file io::close
		}
	} else {
		drop
	}

	buf2 mem::free

	// Read all content
	100 mem::alloc -> read_buf

	"/tmp/test_append.txt" io::Read io::open if {
		-> file
		file read_buf 100 io::read if {
			-> bytes_read
			file io::close
			read_buf bytes_read mem::to_string
			prints       // Print string (non-destructive)
		} else {
			drop file io::close
		}
	} else {
		drop
	}

	read_buf mem::free
}
